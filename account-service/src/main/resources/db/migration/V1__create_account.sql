CREATE TABLE IF NOT EXISTS ADDRESS (
    ADDRESS_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    ADDRESS_ZIP_CODE VARCHAR(10),
    ADDRESS_BASIC VARCHAR(255),
    ADDRESS_ADD VARCHAR(255),
    DELETED BOOLEAN DEFAULT FALSE
);

CREATE TABLE IF NOT EXISTS GOLD_HARRY (
    GOLD_HARRY_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    GOLD_HARRY_LOSS DECIMAL(10,2) NOT NULL,
    DEFAULT_OPTION BOOLEAN NOT NULL DEFAULT FALSE,
    DELETED BOOLEAN DEFAULT FALSE
);

INSERT INTO GOLD_HARRY (GOLD_HARRY_LOSS, DEFAULT_OPTION)
SELECT 1.10, TRUE WHERE NOT EXISTS (SELECT 1 FROM GOLD_HARRY WHERE DEFAULT_OPTION = TRUE);

CREATE TABLE IF NOT EXISTS COMMON_OPTION (
    COMMON_OPTION_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    OPTION_TRADE_TYPE VARCHAR(30),
    OPTION_LEVEL VARCHAR(30),
    DELETED BOOLEAN DEFAULT FALSE,
    GOLD_HARRY_ID BIGINT NOT NULL,
    GOLD_HARRY_LOSS VARCHAR(5),
    CONSTRAINT FK_COMMON_OPTION_GOLD FOREIGN KEY (GOLD_HARRY_ID) REFERENCES GOLD_HARRY(GOLD_HARRY_ID) ON DELETE RESTRICT
);

CREATE TABLE IF NOT EXISTS ADDITIONAL_OPTION (
    OPTION_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    OPTION_APPLY_PAST_SALES BOOLEAN NOT NULL,
    OPTION_MATERIAL_ID VARCHAR(255),
    OPTION_MATERIAL_NAME VARCHAR(255),
    DELETED BOOLEAN DEFAULT FALSE
);

CREATE TABLE IF NOT EXISTS STORE (
    STORE_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    STORE_NAME VARCHAR(30) NOT NULL UNIQUE,
    STORE_OWNER_NAME VARCHAR(30) NOT NULL,
    STORE_PHONE_NUMBER VARCHAR(13),
    STORE_CONTACT_NUMBER_1 VARCHAR(13),
    STORE_CONTACT_NUMBER_2 VARCHAR(13),
    STORE_FAX_NUMBER VARCHAR(16),
    STORE_NOTE VARCHAR(255),
    STORE_DEFAULT BOOLEAN NOT NULL DEFAULT FALSE,
    STORE_DELETED BOOLEAN NOT NULL DEFAULT FALSE,

    CREATE_DATE TIMESTAMPTZ NOT NULL,
    LAST_MODIFIED_DATE TIMESTAMPTZ NOT NULL,

    CREATED_BY VARCHAR(255),
    LAST_MODIFIED_BY VARCHAR(255),

    ADDRESS_ID BIGINT,
    COMMON_OPTION_ID BIGINT,
    OPTION_ID BIGINT,

    EVENT_ID VARCHAR(255),
    CURRENT_GOLD_BALANCE DECIMAL(10, 3) NOT NULL DEFAULT 0.000,
    CURRENT_MONEY_BALANCE BIGINT NOT NULL DEFAULT 0,

    CONSTRAINT FK_STORE_ADDRESS FOREIGN KEY (ADDRESS_ID) REFERENCES ADDRESS(ADDRESS_ID) ON DELETE CASCADE,
    CONSTRAINT FK_STORE_COMMON_OPTION FOREIGN KEY (COMMON_OPTION_ID) REFERENCES COMMON_OPTION(COMMON_OPTION_ID) ON DELETE CASCADE,
CONSTRAINT FK_STORE_ADDITIONAL_OPTION FOREIGN KEY (OPTION_ID) REFERENCES ADDITIONAL_OPTION(OPTION_ID) ON DELETE CASCADE
);

INSERT INTO STORE (STORE_NAME, STORE_OWNER_NAME, STORE_DEFAULT, STORE_DELETED, CREATE_DATE, LAST_MODIFIED_DATE)
SELECT '매장재고', '매장재고', TRUE, FALSE, NOW(), NOW() WHERE NOT EXISTS (SELECT 1 FROM STORE WHERE STORE_NAME = '매장재고');

INSERT INTO COMMON_OPTION (OPTION_TRADE_TYPE, OPTION_LEVEL, DELETED, GOLD_HARRY_ID, GOLD_HARRY_LOSS)
SELECT 'WEIGHT', 'ONE', FALSE, gh.GOLD_HARRY_ID, CAST(gh.GOLD_HARRY_LOSS AS VARCHAR(5))
FROM GOLD_HARRY gh
WHERE gh.DEFAULT_OPTION = TRUE
  AND NOT EXISTS (
    SELECT 1
    FROM COMMON_OPTION co
    WHERE co.GOLD_HARRY_ID = gh.GOLD_HARRY_ID
      AND co.OPTION_TRADE_TYPE = 'WEIGHT'
      AND co.OPTION_LEVEL = 'ONE'
      AND co.DELETED = FALSE
);

UPDATE STORE s
SET COMMON_OPTION_ID = (
    SELECT co.COMMON_OPTION_ID
    FROM COMMON_OPTION co
    WHERE co.OPTION_TRADE_TYPE = 'WEIGHT'
      AND co.OPTION_LEVEL = 'ONE'
      AND co.DELETED = FALSE
    ORDER BY co.COMMON_OPTION_ID
    LIMIT 1
)
WHERE (s.STORE_NAME = '매장재고' OR s.STORE_DEFAULT = TRUE)
  AND s.COMMON_OPTION_ID IS NULL;

CREATE TABLE IF NOT EXISTS FACTORY (
    FACTORY_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    FACTORY_NAME VARCHAR(30) NOT NULL UNIQUE,
    FACTORY_OWNER_NAME VARCHAR(30) NOT NULL,
    FACTORY_PHONE_NUMBER VARCHAR(13),
    FACTORY_CONTACT_NUMBER_1 VARCHAR(13),
    FACTORY_CONTACT_NUMBER_2 VARCHAR(13),
    FACTORY_FAX_NUMBER VARCHAR(16),
    FACTORY_NOTE VARCHAR(255),
    FACTORY_DELETED BOOLEAN NOT NULL DEFAULT FALSE,

    CREATE_DATE TIMESTAMPTZ NOT NULL,
    LAST_MODIFIED_DATE TIMESTAMPTZ NOT NULL,

    CREATED_BY VARCHAR(255),
    LAST_MODIFIED_BY VARCHAR(255),

    ADDRESS_ID BIGINT,
    COMMON_OPTION_ID BIGINT,

    EVENT_ID VARCHAR(255),
    CURRENT_GOLD_BALANCE DECIMAL(10, 3) NOT NULL DEFAULT 0.000,
    CURRENT_MONEY_BALANCE BIGINT NOT NULL DEFAULT 0,

    CONSTRAINT FK_FACTORY_ADDRESS FOREIGN KEY (ADDRESS_ID) REFERENCES ADDRESS(ADDRESS_ID) ON DELETE CASCADE,
    CONSTRAINT FK_FACTORY_COMMON_OPTION FOREIGN KEY (COMMON_OPTION_ID) REFERENCES COMMON_OPTION(COMMON_OPTION_ID) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS TRANSACTION_HISTORY (
    TRANSACTION_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    TRANSACTION_DATE TIMESTAMPTZ NOT NULL,
    TRANSACTION_TYPE VARCHAR(255),
    GOLD_AMOUNT DECIMAL(10, 3),
    MONEY_AMOUNT BIGINT,
    TRANSACTION_DELETED BOOLEAN NOT NULL DEFAULT FALSE,

    STORE_ID BIGINT NOT NULL,
    FACTORY_ID BIGINT NOT NULL,

    EVENT_ID VARCHAR(255),

    CONSTRAINT FK_TRANSACTION_STORE FOREIGN KEY (STORE_ID) REFERENCES STORE(STORE_ID) ON DELETE CASCADE,
    CONSTRAINT FK_TRANSACTION_FACTORY FOREIGN KEY (FACTORY_ID) REFERENCES FACTORY(FACTORY_ID) ON DELETE CASCADE
);