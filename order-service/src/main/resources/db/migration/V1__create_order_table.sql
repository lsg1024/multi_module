-- PRIORITY TABLE
CREATE TABLE IF NOT EXISTS PRIORITY (
    PRIORITY_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    PRIORITY_NAME VARCHAR(255) UNIQUE,
    PRIORITY_DATE INTEGER
);

INSERT INTO PRIORITY (PRIORITY_NAME, PRIORITY_DATE) VALUES ('일반', 7);
INSERT INTO PRIORITY (PRIORITY_NAME, PRIORITY_DATE) VALUES ('급', 5);
INSERT INTO PRIORITY (PRIORITY_NAME, PRIORITY_DATE) VALUES ('초급', 4);

-- ORDERS TABLE
CREATE TABLE IF NOT EXISTS ORDERS (
    ORDER_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    FLOW_CODE BIGINT,
    STORE_ID BIGINT,
    STORE_NAME VARCHAR(255),
    STORE_HARRY DECIMAL(10,2),
    STORE_GRADE VARCHAR(255),
    FACTORY_ID BIGINT,
    FACTORY_NAME VARCHAR(255),
    FACTORY_HARRY DECIMAL(10,2),
    ORDER_NOTE VARCHAR(255),
    PRIORITY_ID BIGINT,
    PRODUCT_STATUS VARCHAR(50) NOT NULL,
    ORDER_STATUS VARCHAR(50) NOT NULL,
    CREATE_AT TIMESTAMPTZ,
    SHIPPING_AT TIMESTAMPTZ,
    ORDER_DELETED BOOLEAN DEFAULT FALSE,
    CONSTRAINT FK_ORDERS_PRIORITY FOREIGN KEY (PRIORITY_ID) REFERENCES PRIORITY(PRIORITY_ID),
    CONSTRAINT UK_ORDERS_FLOW_CODE UNIQUE (FLOW_CODE)
);

CREATE INDEX IF NOT EXISTS IX_ORDERS_STATUS ON ORDERS (PRODUCT_STATUS, ORDER_STATUS);
CREATE INDEX IF NOT EXISTS IX_ORDERS_PRIORITY ON ORDERS (PRIORITY_ID);
CREATE INDEX IF NOT EXISTS IX_CREATE_AT ON ORDERS (CREATE_AT);

-- ORDER_PRODUCT TABLE
CREATE TABLE IF NOT EXISTS ORDER_PRODUCT (
    ORDER_PRODUCT_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    ORDER_ID BIGINT UNIQUE,
    PRODUCT_ID BIGINT,
    PRODUCT_NAME VARCHAR(255),
    PRODUCT_FACTORY_NAME VARCHAR(255),
    PRODUCT_SIZE VARCHAR(50),
    IS_PRODUCT_WEIGHT_SALE BOOLEAN,
    GOLD_WEIGHT DECIMAL(10, 3),
    STONE_WEIGHT DECIMAL(10, 3),
    ORDER_MAIN_STONE_NOTE VARCHAR(255),
    ORDER_ASSISTANCE_STONE_NOTE VARCHAR(255),
    PRODUCT_PURCHASE_COST INT,
    PRODUCT_LABOR_COST INT,
    PRODUCT_ADD_LABOR_COST INT,
    MATERIAL_ID BIGINT,
    MATERIAL_NAME VARCHAR(100),
    CLASSIFICATION_ID BIGINT,
    CLASSIFICATION_NAME VARCHAR(100),
    COLOR_ID BIGINT,
    COLOR_NAME VARCHAR(100),
    SET_TYPE_ID BIGINT,
    SET_TYPE_NAME VARCHAR(100),
    ASSISTANT_STONE BOOLEAN,
    ASSISTANT_STONE_ID BIGINT,
    ASSISTANT_STONE_NAME VARCHAR(100),
    ASSISTANT_STONE_CREATE_AT TIMESTAMPTZ,
    STONE_ADD_LABOR_COST INTEGER,
    CONSTRAINT FK_ORDER_PRODUCT_ORDERS
    FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ORDER_ID)
);

-- STOCK TABLE
CREATE TABLE IF NOT EXISTS STOCK (
    STOCK_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    STOCK_CODE VARCHAR(255),
    FLOW_CODE BIGINT NOT NULL,
    STORE_ID BIGINT,
    STORE_NAME VARCHAR(255),
    STORE_HARRY DECIMAL(10,2),
    STORE_GRADE VARCHAR(255),
    FACTORY_ID BIGINT,
    FACTORY_NAME VARCHAR(255),
    FACTORY_HARRY DECIMAL(10,2),
    STOCK_NOTE VARCHAR(255),
    STOCK_MAIN_STONE_NOTE VARCHAR(255),
    STOCK_ASSISTANCE_STONE_NOTE VARCHAR(255),
    STONE_MAIN_LABOR_COST INT,
    STONE_ASSISTANCE_LABOR_COST INT,
    STONE_ADD_LABOR_COST INT,
    PRODUCT_ID BIGINT,
    PRODUCT_NAME VARCHAR(255),
    PRODUCT_FACTORY_NAME VARCHAR(255),
    PRODUCT_SIZE VARCHAR(50),
    IS_PRODUCT_WEIGHT_SALE BOOLEAN,
    PRODUCT_LABOR_COST INT,
    PRODUCT_ADD_LABOR_COST INT,
    PRODUCT_PURCHASE_COST INT,
    TOTAL_STONE_PURCHASE_COST INT,
    TOTAL_STONE_LABOR_COST INT,
    MATERIAL_ID BIGINT,
    MATERIAL_NAME VARCHAR(100),
    COLOR_ID BIGINT,
    COLOR_NAME VARCHAR(100),
    CLASSIFICATION_ID BIGINT,
    CLASSIFICATION_NAME VARCHAR(100),
    SET_TYPE_ID BIGINT,
    SET_TYPE_NAME VARCHAR(100),
    ASSISTANT_STONE_ID BIGINT,
    ASSISTANT_STONE BOOLEAN,
    ASSISTANT_STONE_NAME VARCHAR(100),
    ASSISTANT_STONE_CREATE_AT TIMESTAMPTZ,
    GOLD_WEIGHT DECIMAL(10, 3),
    STONE_WEIGHT DECIMAL(10, 3),
    STOCK_DELETED BOOLEAN DEFAULT FALSE,
    ORDER_ID BIGINT,
    ORDER_STATUS VARCHAR(50) NOT NULL,
    CONSTRAINT FK_STOCK_ORDERS FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ORDER_ID),
    CONSTRAINT UK_STOCK_CODE UNIQUE (STOCK_CODE),
    CONSTRAINT UK_STOCK_FLOW_CODE UNIQUE (FLOW_CODE),
    CONSTRAINT UK_STOCK_ORDER UNIQUE (ORDER_ID)
);

ALTER TABLE STOCK ADD COLUMN create_date TIMESTAMP;
ALTER TABLE STOCK ADD COLUMN last_modified_date TIMESTAMP;

-- ORDER_STONE TABLE
CREATE TABLE IF NOT EXISTS ORDER_STONE (
    ORDER_STONE_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    ORIGIN_STONE_ID BIGINT,
    ORIGIN_STONE_NAME VARCHAR(255),
    ORIGIN_STONE_WEIGHT DECIMAL(10, 3),
    STONE_PURCHASE_COST INTEGER,
    STONE_ADD_LABOR_COST INTEGER,
    STONE_LABOR_COST INTEGER,
    STONE_QUANTITY INTEGER,
    IS_MAIN_STONE BOOLEAN,
    IS_INCLUDE_STONE BOOLEAN,
    ORDER_ID BIGINT,
    STOCK_ID BIGINT,
    CONSTRAINT FK_ORDER_STONE_ORDERS FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ORDER_ID),
    CONSTRAINT FK_ORDER_STONE_STOCK FOREIGN KEY (STOCK_ID) REFERENCES STOCK(STOCK_ID)
);

CREATE INDEX IF NOT EXISTS IX_ORDER_STONE_ORDER ON ORDER_STONE (ORDER_ID);
CREATE INDEX IF NOT EXISTS IX_ORDER_STONE_STOCK ON ORDER_STONE (STOCK_ID);

-- STATUS_HISTORY TABLE
CREATE TABLE IF NOT EXISTS STATUS_HISTORY (
    ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    FLOW_CODE BIGINT NOT NULL,
    SOURCE_TYPE VARCHAR(32),
    PHASE VARCHAR(32),
    KIND VARCHAR(32),
    FROM_VALUE VARCHAR(255),
    TO_VALUE VARCHAR(255),
    CREATED_AT TIMESTAMPTZ,
    USER_NAME VARCHAR(255)
);

CREATE INDEX IF NOT EXISTS idx_hist_flowcode_created ON STATUS_HISTORY (FLOW_CODE, CREATED_AT);

-- SALE TABLE
CREATE TABLE IF NOT EXISTS SALE (
    SALE_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    SALE_CODE BIGINT,
    SALE_STATUS VARCHAR(50),
    STORE_ID BIGINT NOT NULL,
    STORE_NAME VARCHAR(255) NOT NULL,
    create_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_modified_date TIMESTAMP,
    CREATED_BY         VARCHAR(50) NOT NULL,
    LAST_MODIFIED_BY   VARCHAR(50),
    CONSTRAINT UK_SALE_CODE UNIQUE (SALE_CODE)
);

-- SALE_ITEM TABLE
CREATE TABLE IF NOT EXISTS SALE_ITEM (
    SALE_ITEM_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    SALE_ID BIGINT,
    STOCK_ID BIGINT,
    SALE_CODE BIGINT NOT NULL,
    FLOW_CODE BIGINT NOT NULL,
    create_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_modified_date TIMESTAMP,
    CREATED_BY         VARCHAR(50) NOT NULL,
    LAST_MODIFIED_BY   VARCHAR(50),
    CONSTRAINT UK_SALE_ITEM_STOCK UNIQUE (STOCK_ID),
    CONSTRAINT FK_SALE_ITEM_SALE FOREIGN KEY (SALE_ID) REFERENCES SALE(SALE_ID),
    CONSTRAINT FK_SALE_ITEM_STOCK FOREIGN KEY (STOCK_ID) REFERENCES STOCK(STOCK_ID)
);

CREATE INDEX IF NOT EXISTS IX_SALE_ITEM_SALE ON SALE_ITEM (SALE_ID, create_date);
CREATE INDEX IF NOT EXISTS IX_SALE_ITEM_STOCK ON SALE_ITEM (STOCK_ID);

-- SALE_PAYMENT TABLE
CREATE TABLE IF NOT EXISTS SALE_PAYMENT (
    SALE_PAYMENT_ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    SALE_ID BIGINT NOT NULL,
    SALE_CODE BIGINT NOT NULL,
    FLOW_CODE BIGINT NOT NULL,
    STORE_ID BIGINT NOT NULL,
    STORE_NAME VARCHAR(255) NOT NULL,
    SALE_STATUS VARCHAR(50),
    CASH_AMOUNT INTEGER,
    GOLD_MATERIAL VARCHAR(100),
    GOLD_WEIGHT DECIMAL(18, 3),
    PAYMENT_NOTE VARCHAR(255),
    create_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_modified_date TIMESTAMP,
    CREATED_BY         VARCHAR(50) NOT NULL,
    LAST_MODIFIED_BY   VARCHAR(50),
    IDEMP_KEY VARCHAR(100) NOT NULL,
    PAYMENT_DELETED BOOLEAN DEFAULT FALSE,
    DELETED_AT TIMESTAMPTZ,
    CONSTRAINT FK_PAYMENT_SALE FOREIGN KEY (SALE_ID) REFERENCES SALE(SALE_ID),
    CONSTRAINT UK_PAYMENT_IDEMP UNIQUE (IDEMP_KEY)
);