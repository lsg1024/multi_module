name: Deploy Multi-Module to Synology NAS

on:
  push:
    branches: [ "production" ]
  pull_request:
    types: [closed]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Create Config Server Properties
        run: |
          mkdir -p config-server/src/main/resources
          echo "spring.application.name=ConfigServer" > config-server/src/main/resources/application.properties
          echo "spring.profiles.active=secret" >> config-server/src/main/resources/application.properties
          echo "server.port=${{ secrets.CONFIG_PORT }}" >> config-server/src/main/resources/application.properties
          echo "spring.cloud.config.server.git.uri=${{ secrets.PRIVATE_GIT }}" >> config-server/src/main/resources/application.properties
          echo "spring.cloud.config.server.git.ignoreLocalSshSettings=true" >> config-server/src/main/resources/application.properties
          echo "spring.cloud.config.server.git.private-key=${{ secrets.PRIVATE_URL }}" >> config-server/src/main/resources/application.properties
          
          cat config-server/src/main/resources/application.properties

      - name: Grant execute permission for Gradle
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean :config-server:build -x test

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and Push Config Server Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/config-server:latest ./config-server
          docker push ${{ secrets.DOCKER_USERNAME }}/config-server:latest

  deploy-to-nas:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: SSH into Synology NAS and Deploy
        env:
          NAS_USERNAME: ${{ secrets.NAS_USERNAME }}
          NAS_PASSWORD: ${{ secrets.NAS_PASSWORD }}
          NAS_HOST: ${{ secrets.NAS_HOST }}
          SSH_PORT: ${{ secrets.NAS_SSH_PORT }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          CONFIG_PORT: ${{ secrets.CONFIG_PORT }}
        run: |
          sshpass -p "$NAS_PASSWORD" ssh -t -o StrictHostKeyChecking=no -p $SSH_PORT $NAS_USERNAME@$NAS_HOST << EOF
          
            export PATH=/usr/local/bin:\$PATH
            echo "=== 1. Docker Login ==="
            docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  
            echo "=== 2. Pull Config Server Image ==="
            docker pull $DOCKER_USERNAME/config-server:latest
  
            echo "=== 3. Reset Container ==="
            docker stop config-server || true
            docker rm config-server || true
  
            echo "=== 4. Run Config Server ==="
            docker run -d \
              --name config-server \
              -p $CONFIG_PORT:$CONFIG_PORT \
              $DOCKER_USERNAME/config-server:latest
  
            echo "=== Deployment Completed ==="
            exit
          EOF
